---
- name: Read existing daemon.json if present
  ansible.builtin.slurp:
    src: /etc/docker/daemon.json
  register: docker_daemon_content
  failed_when: false
  changed_when: false

- name: Parse existing daemon.json
  ansible.builtin.set_fact:
    docker_config_data: "{{ docker_daemon_content['content'] | b64decode | from_json | default({}) }}"
  when:
    - docker_daemon_content is succeeded
    - docker_daemon_content['content'] is defined

- name: Set empty config if file doesn't exist or invalid
  ansible.builtin.set_fact:
    docker_config_data: {}
  when: docker_config_data is not defined

- name: Deploy /etc/docker/daemon.json
  ansible.builtin.template:
    src: daemon.json.j2
    dest: /etc/docker/daemon.json
    owner: root
    group: root
    mode: "0644"
    backup: true
    validate: python3 -m json.tool %s
  notify: Restart docker
